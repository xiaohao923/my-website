<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç²å–å®šä½ Â· å®‰å…¨ä¸Šå‚³</title>
  <meta name="description" content="ä¸€éµå®‰å…¨å‚³é€åº§æ¨™ï¼Œå¸¸è¦‹éŒ¯èª¤è‡ªå‹•ä¸­æ–‡åŒ–æç¤ºã€‚" />
  <meta name="color-scheme" content="light dark" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0b0b12;
      --bg2:#0f1020;
      --ink: #eaeaff;
      --muted:#a6a6c9;
      --accent:#8b7bff;
      --accent-2:#ffe94d;
      --success:#42d392;
      --danger:#ff6b6b;
      --ring: 0 0 0 .12rem rgba(139,123,255,.45), 0 0 1.4rem rgba(139,123,255,.35);
      --shadow: 0 10px 40px rgba(0,0,0,.35);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; min-height: 100svh;
      font-family: "Noto Sans TC","Inter",system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,"Helvetica Neue",sans-serif;
      color: var(--ink);
      background: linear-gradient(180deg, var(--bg), var(--bg2));
      display: grid; place-items: center;
    }
    .wrap {
      width: min(680px, 92vw);
      background: rgba(255,255,255,.08);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,.08);
    }
    h1 { margin: 0 0 10px; font-size: clamp(20px, 3.8vw, 28px); }
    p.lead { color: var(--muted); margin: 0 0 16px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 560px){ .row-2 { grid-template-columns: 1fr 1fr; } }

    label { font-weight: 600; font-size: .95rem; }
    input, select {
      width: 100%; padding: 12px 14px; border-radius: 10px;
      border: 1px solid rgba(255,255,255,.2);
      background: rgba(255,255,255,.05); color: var(--ink);
      outline: none; transition: box-shadow .2s,border-color .2s;
    }
    input:focus, select:focus { box-shadow: var(--ring); border-color: rgba(139,123,255,.55); }

    .actions { margin-top: 14px; display: grid; grid-template-columns: 1fr; gap: 10px; }
    button {
      width: 100%; padding: 14px; font-size: 1.05rem;
      border: none; border-radius: 12px; font-weight: 700;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #0f0f17; transition: transform .06s ease, filter .2s ease, opacity .25s;
    }
    button:active { transform: translateY(1px); }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .ghost { background: transparent; border: 1px dashed rgba(255,255,255,.2); color: var(--ink); }

    .status { margin-top: 14px; font-weight: 700; color: var(--muted); white-space: pre-line; }
    .ok { color: var(--success); }
    .bad { color: var(--danger); }
    .tip { font-size: .9rem; color: var(--muted); margin-top: 6px; }

    .result { margin-top: 14px; display: grid; gap: 6px; font-size: .98rem; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: rgba(255,255,255,.08); padding: 2px 6px; border-radius: 6px; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background: rgba(255,255,255,.08); font-size:.85rem }
    .row-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center }
  </style>
</head>
<body>
  <main class="wrap" role="main">
    <h1>ç¢ºèªåœ°å€ â¬‡ï¸</h1>
    <p class="lead">è«‹å…ˆè¼¸å…¥ä½¿ç”¨è€…åç¨±ä¸¦æˆæ¬Šå®šä½ï¼Œåº§æ¨™æœƒ<strong>åŠ å¯†å‚³é€</strong>åˆ°ä¼ºæœå™¨ã€‚å¸¸è¦‹éŒ¯èª¤æœƒè‡ªå‹•ä¸­æ–‡åŒ–ï¼Œä¸ç”¨æ€•ï½</p>

    <div class="row">
      <div>
        <label for="username">ä½¿ç”¨è€…åç¨±</label>
        <input type="text" id="username" placeholder="è«‹è¼¸å…¥ä½¿ç”¨è€…åç¨±" autocomplete="username" />
        <div class="tip" id="nameTip">æœƒè‡ªå‹•è¨˜ä½ä½ è¼¸å…¥çš„åç¨±</div>
      </div>
      <div class="row row-2">
        <button id="sendLocationBtn" disabled>ğŸ“ å‚³é€åœ°å€</button>
        <button id="retryBtn" class="ghost" disabled>é‡æ–°å˜—è©¦</button>
      </div>
    </div>

    <div id="status" class="status">æƒ³è¼¸è´è«‹å…ˆè¼¸å…¥åç¨±å†é»æ“Šä¸Šæ–¹æŒ‰éµï¼</div>

    <section id="result" class="result" hidden>
      <div><strong>åº§æ¨™ï¼š</strong><span id="coords">â€”</span></div>
      <div class="row-inline">
        <button id="copyBtn" class="ghost" disabled>è¤‡è£½åº§æ¨™</button>
        <a id="gmaps" class="pill" href="#" target="_blank" rel="noopener">åœ¨åœ°åœ–æŸ¥çœ‹ â†—</a>
        <span id="acc" class="pill" title="å®šä½ç²¾åº¦ (å…¬å°º)">ç²¾åº¦ï¼š<span id="accVal">â€”</span> m</span>
      </div>
    </section>

    <details class="tip" style="margin-top:10px">
      <summary>ç„¡æ³•å®šä½ï¼Ÿé€ŸæŸ¥æŒ‡å¼•</summary>
      <ul>
        <li>è«‹ç¢ºèªä½¿ç”¨ <span class="kbd">https://</span> å®‰å…¨é€£ç·šï¼ˆHTTP ä¾†æºæœƒè¢«ç€è¦½å™¨æ“‹å®šä½ï¼‰ã€‚</li>
        <li>æª¢æŸ¥ç€è¦½å™¨çš„ã€Œç¶²ç«™æ¬Šé™ â†’ å®šä½ã€æ˜¯å¦å…è¨±ã€‚</li>
        <li>iOS Safariï¼šå‰å¾€ <span class="kbd">è¨­å®š â†’ Safari â†’ ä½ç½®</span> å…è¨±ï¼›æˆ–åœ¨ç¶²ç«™ä½å€åˆ—çš„ã€ŒaAã€â†’ã€Œç¶²ç«™è¨­å®šã€ã€‚</li>
        <li>æ¡Œæ©Ÿï¼šWindows éœ€é–‹å•Ÿ <span class="kbd">è¨­å®š â†’ éš±ç§æ¬Šèˆ‡å®‰å…¨æ€§ â†’ ä½ç½®</span>ï¼›Mac éœ€æ–¼ <span class="kbd">ç³»çµ±è¨­å®š â†’ éš±ç§æ¬Šèˆ‡å®‰å…¨æ€§ â†’ å®šä½æœå‹™</span> é–‹å•Ÿç€è¦½å™¨å®šä½ã€‚</li>
      </ul>
    </details>
  </main>

  <script>
    // ====== åŸºæœ¬ DOM ======
    const usernameInput = document.getElementById('username');
    const btnSend = document.getElementById('sendLocationBtn');
    const btnRetry = document.getElementById('retryBtn');
    const statusEl = document.getElementById('status');
    const coordsEl = document.getElementById('coords');
    const result = document.getElementById('result');
    const copyBtn = document.getElementById('copyBtn');
    const gmapsLink = document.getElementById('gmaps');
    const accVal = document.getElementById('accVal');

    // ====== å¾Œç«¯æ¥æ”¶ç«¯é»ï¼ˆFormspree æˆ–è‡ªæ¶ APIï¼‰======
    const FORMSPREE_ENDPOINT = 'https://formspree.io/f/xnndkpja';

    // ====== å·¥å…·ï¼šä¸­æ–‡åŒ–éŒ¯èª¤ ======
    function geoErrorToZh(err){
      // æ¨™æº– GeolocationPositionError: code 1,2,3
      const mapByCode = {
        1: 'æ¬Šé™è¢«æ‹’çµ•ï¼šè«‹å…è¨±æœ¬ç¶²ç«™ä½¿ç”¨å®šä½æ¬Šé™ã€‚',
        2: 'ç„¡æ³•å–å¾—ä½ç½®ï¼šè£ç½®æœªå›å ±åº§æ¨™ï¼Œæˆ–æ˜¯æ²’æœ‰å¯ç”¨çš„å®šä½ä¾†æºã€‚',
        3: 'é€¾æ™‚ï¼šå®šä½èŠ±å¤ªä¹…æ™‚é–“ï¼Œè«‹ç§»å‹•åˆ°è¼ƒé–‹é—Šè™•æˆ–ç¨å¾Œé‡è©¦ã€‚'
      };
      if (typeof err?.code === 'number' && mapByCode[err.code]) return mapByCode[err.code];

      // é‡å°å¸¸è¦‹è¨Šæ¯å†ç´°åˆ†
      const msg = (err?.message || '').toLowerCase();
      if (msg.includes('only secure origins are allowed') || location.protocol !== 'https:')
        return 'éœ€ä½¿ç”¨ HTTPS å®‰å…¨é€£ç·šæ‰å¯å®šä½ï¼Œè«‹æ”¹ç”¨ https:// ç¶²å€æˆ–éƒ¨ç½²åˆ°æ”¯æ´ HTTPS çš„ä¸»æ©Ÿã€‚';
      if (msg.includes('permission') && msg.includes('denied'))
        return 'ä½ æ‹’çµ•äº†å®šä½æ¬Šé™ï¼Œè«‹åˆ°ç€è¦½å™¨çš„ç¶²ç«™æ¬Šé™æŠŠã€Œä½ç½®ã€æ”¹æˆå…è¨±ã€‚';
      if (msg.includes('timeout'))
        return 'å®šä½é€¾æ™‚ï¼Œé™„è¿‘è¨Šè™Ÿæˆ–ç’°å¢ƒå¯èƒ½ä¸ä½³ï¼Œè«‹ç§»å‹•åˆ°ç©ºæ› è™•å†è©¦ã€‚';
      if (msg.includes('unavailable'))
        return 'ç›®å‰ç„¡æ³•å–å¾—ä½ç½®ï¼Œå¯èƒ½æ˜¯è£ç½®æ²’æœ‰ GPS æˆ– GPS å°šæœªå•Ÿç”¨ã€‚';

      return 'å®šä½å¤±æ•—ï¼š' + (err?.message || 'ä¸æ˜éŒ¯èª¤');
    }

    function networkErrorToZh(err){
      const msg = (err?.message || '').toLowerCase();
      if (msg.includes('failed to fetch')) return 'ç¶²è·¯è«‹æ±‚å¤±æ•—ï¼šå¯èƒ½æ˜¯é›¢ç·šã€CORS æˆ–ä¼ºæœå™¨ç„¡å›æ‡‰ã€‚';
      if (msg.includes('cors')) return 'CORS é™åˆ¶ï¼šè«‹ç¢ºèªä¼ºæœå™¨å…è¨±æœ¬ç¶²åŸŸç™¼é€è«‹æ±‚ã€‚';
      return 'é€å‡ºå¤±æ•—ï¼š' + (err?.message || 'ä¸æ˜éŒ¯èª¤');
    }

    function httpStatusToZh(status){
      const m = {
        400:'éŒ¯èª¤çš„è«‹æ±‚ï¼ˆ400ï¼‰ï¼šè«‹æª¢æŸ¥é€å‡ºçš„è³‡æ–™æ ¼å¼ã€‚',
        401:'æœªæˆæ¬Šï¼ˆ401ï¼‰ï¼šè«‹ç¢ºèªä¼ºæœå™¨é‡‘é‘°æˆ–æˆæ¬Šè¨­å®šã€‚',
        403:'è¢«æ‹’çµ•ï¼ˆ403ï¼‰ï¼šä½ æ²’æœ‰æ¬Šé™å‘¼å«æ­¤ç«¯é»ã€‚',
        404:'æ‰¾ä¸åˆ°è³‡æºï¼ˆ404ï¼‰ï¼šè«‹ç¢ºèªç«¯é» URL æ˜¯å¦æ­£ç¢ºã€‚',
        413:'å…§å®¹å¤ªå¤§ï¼ˆ413ï¼‰ï¼šå‚³é€è³‡æ–™è¶…éä¼ºæœå™¨å…è¨±ä¸Šé™ã€‚',
        429:'è«‹æ±‚éå¤šï¼ˆ429ï¼‰ï¼šå‘¼å«å¤ªé »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚',
        500:'ä¼ºæœå™¨éŒ¯èª¤ï¼ˆ500ï¼‰ï¼šä¼ºæœå™¨ç™¼ç”Ÿå•é¡Œï¼Œè«‹ç¨å¾Œå†è©¦ã€‚',
        502:'é–˜é“éŒ¯èª¤ï¼ˆ502ï¼‰ï¼šä¸Šæ¸¸æœå‹™ç•°å¸¸ã€‚',
        503:'æœå‹™ä¸å¯ç”¨ï¼ˆ503ï¼‰ï¼šä¼ºæœå™¨æš«æ™‚å¿™ç¢Œæˆ–ç¶­è­·ä¸­ã€‚',
        504:'é€¾æ™‚ï¼ˆ504ï¼‰ï¼šä¼ºæœå™¨å›æ‡‰é€¾æ™‚ã€‚'
      };
      return m[status] || `é€å‡ºå¤±æ•—ï¼ˆHTTP ${status}ï¼‰`;
    }

    // ====== UI helpers ======
    function setLoading(loading){
      btnSend.disabled = loading || usernameInput.value.trim()==='';
      btnRetry.disabled = loading;
      btnSend.textContent = loading ? 'å‚³é€ä¸­â€¦' : 'ğŸ“ å‚³é€åœ°å€';
    }

    function revealResult(lat,lng,acc){
      coordsEl.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      accVal.textContent = acc ? Math.round(acc) : 'â€”';
      gmapsLink.href = `https://maps.google.com/?q=${lat},${lng}`;
      result.hidden = false;
      copyBtn.disabled = false;
    }

    async function copyCoords(){
      try{
        await navigator.clipboard.writeText(coordsEl.textContent);
        statusEl.textContent = 'âœ“ å·²è¤‡è£½åº§æ¨™åˆ°å‰ªè²¼ç°¿ã€‚';
        statusEl.className = 'status ok';
      }catch{
        statusEl.textContent = 'è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–åº§æ¨™å¾ŒæŒ‰ Ctrl/Cmd+Cã€‚';
        statusEl.className = 'status bad';
      }
    }

    async function postJSON(url, data){
      try{
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept':'application/json' },
          body: JSON.stringify(data)
        });
        if (!res.ok) throw new Error(httpStatusToZh(res.status));
        return true;
      }catch(err){
        throw new Error(networkErrorToZh(err));
      }
    }

    // ====== ä¸»æµç¨‹ ======
    async function sendLocationFlow(){
      if (!('geolocation' in navigator)){
        statusEl.textContent = 'æŠ±æ­‰ï¼Œç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½ã€‚å»ºè­°æ”¹ç”¨ Chrome / Safari / Edge ä¸¦ç¢ºä¿ HTTPSã€‚';
        statusEl.className = 'status bad';
        return;
      }

      // ç¢ºä¿æœ‰åç¨±
      const name = usernameInput.value.trim();
      if (!name){
        statusEl.textContent = 'è«‹å…ˆè¼¸å…¥ä½¿ç”¨è€…åç¨±ï½';
        statusEl.className = 'status bad';
        return;
      }

      setLoading(true);

      const geoOpts = { enableHighAccuracy:true, timeout: 15000, maximumAge: 0 };
      navigator.geolocation.getCurrentPosition(async pos => {
        const { latitude, longitude, accuracy } = pos.coords;

        const payload = {
          username: name,
          latitude, longitude,
          accuracy,
          userAgent: navigator.userAgent,
          language: navigator.language,
          timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
          timestamp: new Date().toISOString()
        };

        try{
          await postJSON(FORMSPREE_ENDPOINT, payload);
          revealResult(latitude, longitude, accuracy);
          statusEl.textContent = `âœ“ å·²é€å‡ºï¼š${name}`;
          statusEl.className = 'status ok';
          localStorage.setItem('geo_name', name);
        }catch(err){
          revealResult(latitude, longitude, accuracy);
          statusEl.textContent = String(err.message || err);
          statusEl.className = 'status bad';
        }finally{
          setLoading(false);
        }
      }, err => {
        statusEl.textContent = geoErrorToZh(err);
        statusEl.className = 'status bad';
        setLoading(false);
      }, geoOpts);
    }

    // ====== æ¬Šé™åµæ¸¬èˆ‡ UX ======
    async function initPermissionHints(){
      try{
        if (!('permissions' in navigator)) return; // Safari å¯èƒ½æ²’æœ‰
        const q = await navigator.permissions.query({ name: 'geolocation' });
        // æ ¹æ“šç‹€æ…‹é¡¯ç¤ºæç¤º
        if (q.state === 'denied'){
          statusEl.textContent = 'å®šä½æ¬Šé™ç›®å‰ç‚ºã€Œæ‹’çµ•ã€ã€‚è«‹åˆ°ç€è¦½å™¨çš„ç¶²ç«™æ¬Šé™å°‡ã€Œä½ç½®ã€æ”¹ç‚ºå…è¨±å¾Œå†é‡è©¦ã€‚';
          statusEl.className = 'status bad';
        } else if (q.state === 'prompt'){
          statusEl.textContent = 'è«‹åœ¨é€å‡ºæ™‚å…è¨±ã€Œä½ç½®ã€æ¬Šé™ï¼Œä»¥ä¾¿å–å¾—åº§æ¨™ã€‚';
          statusEl.className = 'status';
        } else if (q.state === 'granted'){
          statusEl.textContent = 'å®šä½æ¬Šé™å·²å…è¨±ï¼Œè¼¸å…¥åç¨±å¾Œå³å¯å‚³é€ã€‚';
          statusEl.className = 'status ok';
        }
        q.onchange = () => {
          initPermissionHints();
        };
      }catch{ /* ignore */ }
    }

    // ====== ç¶å®šäº‹ä»¶ ======
    usernameInput.addEventListener('input', () => {
      const hasName = usernameInput.value.trim() !== '';
      btnSend.disabled = !hasName;
      btnRetry.disabled = !hasName;
    });

    btnSend.addEventListener('click', sendLocationFlow);
    btnRetry.addEventListener('click', sendLocationFlow);
    copyBtn.addEventListener('click', copyCoords);

    // ====== é–‹æ©Ÿåˆå§‹åŒ– ======
    (function init(){
      // HTTPS æª¢æŸ¥
      if (location.protocol !== 'https:' && location.hostname !== 'localhost'){
        statusEl.textContent = 'âš  ä½ ç›®å‰ä¸æ˜¯åœ¨ HTTPS é€£ç·šï¼Œç€è¦½å™¨å¯èƒ½æœƒæ“‹å®šä½ã€‚è«‹æ”¹ç”¨ https:// ç¶²å€ã€‚';
        statusEl.className = 'status bad';
      }
      // é‚„åŸä¸Šæ¬¡åç¨±
      const saved = localStorage.getItem('geo_name');
      if (saved){ usernameInput.value = saved; btnSend.disabled = false; btnRetry.disabled = false; }
      initPermissionHints();
    })();
  </script>
</body>
</html>
