<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç²å–å®šä½ Â· å®‰å…¨ä¸Šå‚³ï¼ˆProï¼‰</title>
  <meta name="description" content="ä¸€éµå®‰å…¨å‚³é€åº§æ¨™ï¼Œé›¢ç·šé‡è©¦ã€éŒ¯èª¤ä¸­æ–‡åŒ–ã€åˆ†äº«åœ°åœ–é€£çµã€‚" />
  <meta name="color-scheme" content="light dark" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#0b0b12;--bg2:#0f1020;--ink:#eaeaff;--muted:#a6a6c9;--accent:#8b7bff;--accent-2:#ffe94d;--success:#42d392;--danger:#ff6b6b;--ring:0 0 0 .12rem rgba(139,123,255,.45),0 0 1.4rem rgba(139,123,255,.35);--shadow:0 10px 40px rgba(0,0,0,.35);--radius:16px
    }
    *{box-sizing:border-box}
    body{margin:0;min-height:100svh;font-family:"Noto Sans TC","Inter",system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,"Helvetica Neue",sans-serif;color:var(--ink);background:linear-gradient(180deg,var(--bg),var(--bg2));display:grid;place-items:center}
    .wrap{width:min(760px,94vw);background:rgba(255,255,255,.08);border-radius:var(--radius);padding:24px 22px;box-shadow:var(--shadow);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.08)}
    h1{margin:0 0 10px;font-size:clamp(20px,3.6vw,28px)}
    p.lead{color:var(--muted);margin:0 0 16px}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:1fr}
    @media (min-width:600px){.grid-2{grid-template-columns:1fr 1fr}}
    label{font-weight:700;font-size:.95rem}
    input,select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.05);color:var(--ink);outline:none;transition:box-shadow .2s,border-color .2s}
    input:focus,select:focus{box-shadow:var(--ring);border-color:rgba(139,123,255,.55)}
    .actions{display:grid;gap:10px;margin-top:6px}
    button{width:100%;padding:14px;font-size:1.05rem;border:none;border-radius:14px;font-weight:800;cursor:pointer;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#0f0f17;transition:transform .06s ease,filter .2s ease,opacity .25s}
    button.ghost{background:transparent;border:1px dashed rgba(255,255,255,.25);color:var(--ink)}
    button:disabled{opacity:.5;cursor:not-allowed}
    button:active{transform:translateY(1px)}
    .row-inline{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .status{margin-top:12px;font-weight:800;color:var(--muted);white-space:pre-line}
    .ok{color:var(--success)}.bad{color:var(--danger)}
    .tip{font-size:.9rem;color:var(--muted);margin-top:6px}
    .result{margin-top:14px;display:grid;gap:8px}
    .card{padding:12px;border:1px solid rgba(255,255,255,.13);border-radius:14px;background:rgba(255,255,255,.06)}
    .kv{display:grid;grid-template-columns:110px 1fr;gap:6px;align-items:center}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.08);font-size:.85rem}
    .sr{position:absolute;left:-9999px}
    .toast{position:fixed;inset:auto 12px 12px auto;background:rgba(0,0,0,.7);color:#fff;padding:8px 12px;border-radius:10px;opacity:0;transform:translateY(8px);transition:opacity .2s,transform .2s}
    .toast.show{opacity:1;transform:translateY(0)}
  </style>
</head>
<body>
  <main class="wrap" role="main">
    <h1>ç¢ºèªåœ°å€ â¬‡ï¸</h1>
    <p class="lead">è¼¸å…¥åç¨±ä¸¦æˆæ¬Šå®šä½ï¼Œç³»çµ±æœƒ<strong>åŠ å¯†å‚³é€</strong>åº§æ¨™èˆ‡åœ°åœ–é€£çµã€‚å¸¸è¦‹éŒ¯èª¤æœƒè‡ªå‹•ä¸­æ–‡åŒ–ã€‚</p>

    <div class="grid grid-2" style="align-items:end">
      <div>
        <label for="username">ä½¿ç”¨è€…åç¨±</label>
        <input id="username" placeholder="è«‹è¼¸å…¥ä½¿ç”¨è€…åç¨±" autocomplete="username" />
        <div class="tip" id="nameTip">æœƒè‡ªå‹•è¨˜ä½ä½ ä¸Šæ¬¡è¼¸å…¥çš„åç¨±</div>
      </div>
      <div>
        <label for="mapProvider">åœ°åœ–æœå‹™</label>
        <select id="mapProvider">
          <option value="auto">è‡ªå‹•ï¼ˆiOSâ†’Apple / å…¶ä»–â†’Googleï¼‰</option>
          <option value="google">Google Maps</option>
          <option value="apple">Apple åœ°åœ–</option>
          <option value="osm">OpenStreetMap</option>
        </select>
      </div>
    </div>

    <div class="actions">
      <div class="grid grid-2">
        <button id="sendLocationBtn" disabled>ğŸ“ æŸ¥è©¢åœ°å€</button>
        <button id="retryBtn" class="ghost" disabled>é‡æ–°å˜—è©¦</button>
      </div>
      <div class="row-inline">
        <button id="shareBtn" class="ghost" disabled>åˆ†äº«é€£çµ</button>
        <span class="pill">ç²¾åº¦ï¼š<span id="accVal">â€”</span> m</span>
      </div>
    </div>

    <div id="status" class="status" aria-live="polite">æƒ³è¼¸è´è«‹å…ˆè¼¸å…¥åç¨±å†é»æ“Šä¸Šæ–¹æŒ‰éµï¼</div>

    <section id="result" class="result" hidden>
      <div class="card">
        <div class="kv"><strong>ç·¯åº¦</strong><span id="latText" class="mono">â€”</span></div>
        <div class="kv"><strong>ç¶“åº¦</strong><span id="lngText" class="mono">â€”</span></div>
        <div class="kv"><strong>åº§æ¨™</strong><span id="coords" class="mono">â€”</span></div>
      </div>
      <div class="row-inline">
        <button id="copyLat" class="ghost" disabled>è¤‡è£½ç·¯åº¦</button>
        <button id="copyLng" class="ghost" disabled>è¤‡è£½ç¶“åº¦</button>
        <button id="copyBoth" class="ghost" disabled>è¤‡è£½åº§æ¨™</button>
        <a id="mapLink" class="pill" href="#" target="_blank" rel="noopener">åœ¨åœ°åœ–æŸ¥çœ‹ â†—</a>
        <a id="altMapLink" class="pill" href="#" target="_blank" rel="noopener">å‚™ç”¨åœ°åœ– â†—</a>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="assertive"></div>

  <script>
    // ====== DOM ======
    const $ = sel => document.querySelector(sel);
    const usernameInput = $('#username');
    const mapProviderSel = $('#mapProvider');
    const btnSend = $('#sendLocationBtn');
    const btnRetry = $('#retryBtn');
    const btnShare = $('#shareBtn');
    const statusEl = $('#status');
    const result = $('#result');
    const latText = $('#latText');
    const lngText = $('#lngText');
    const coordsEl = $('#coords');
    const accVal = $('#accVal');
    const copyLatBtn = $('#copyLat');
    const copyLngBtn = $('#copyLng');
    const copyBothBtn = $('#copyBoth');
    const mapLink = $('#mapLink');
    const altMapLink = $('#altMapLink');
    const toast = $('#toast');

    // ====== è¨­å®š ======
    const FORMSPREE_ENDPOINT = 'https://formspree.io/f/xnndkpja';
    const CLICK_COOLDOWN_MS = 1200; // é˜²æ­¢é€£é»

    // ====== å°å·¥å…· ======
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1600); }
    function setLoading(loading){
      btnSend.disabled = loading || usernameInput.value.trim()==='';
      btnRetry.disabled = loading || usernameInput.value.trim()==='';
      btnShare.disabled = loading;
      btnSend.textContent = loading ? 'å‚³é€ä¸­â€¦' : 'ğŸ“ å‚³é€åœ°å€';
    }

    function isIOS(){ return /iP(hone|od|ad)/.test(navigator.platform) || /iOS|iPhone|iPad|iPod/.test(navigator.userAgent); }

    function buildMapUrls(lat,lng,provider){
      const g = `https://maps.google.com/?q=${lat},${lng}&ll=${lat},${lng}&z=18`;
      const a = `https://maps.apple.com/?ll=${lat},${lng}&q=${lat},${lng}`;
      const o = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=18/${lat}/${lng}`;
      let primary=g, secondary=o;
      if (provider==='apple' || (provider==='auto' && isIOS())){ primary=a; secondary=g; }
      if (provider==='osm'){ primary=o; secondary=g; }
      if (provider==='google'){ primary=g; secondary=o; }
      return {primary, secondary, google:g, apple:a, osm:o};
    }

    function revealResult(lat,lng,acc,provider){
      latText.textContent = lat.toFixed(6);
      lngText.textContent = lng.toFixed(6);
      coordsEl.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      accVal.textContent = acc ? Math.round(acc) : 'â€”';
      const {primary, secondary} = buildMapUrls(lat,lng,provider);
      mapLink.href = primary; altMapLink.href = secondary; result.hidden = false;
      [copyLatBtn, copyLngBtn, copyBothBtn].forEach(b=>b.disabled=false);
      btnShare.disabled = !(navigator.share || navigator.canShare);
      if (acc && acc > 100){ statusEl.textContent = `å®šä½æˆåŠŸï¼Œä½†ç²¾åº¦è¼ƒå·®ï¼ˆç´„ ${Math.round(acc)} å…¬å°ºï¼‰ï¼Œå»ºè­°åˆ°ç©ºæ› è™•é‡è©¦ã€‚`; statusEl.className='status'; }
    }

    // ====== éŒ¯èª¤ä¸­æ–‡åŒ– ======
    function geoErrorToZh(err){
      const mapByCode={1:'æ¬Šé™è¢«æ‹’çµ•ï¼šè«‹å…è¨±æœ¬ç¶²ç«™ä½¿ç”¨å®šä½æ¬Šé™ã€‚',2:'ç„¡æ³•å–å¾—ä½ç½®ï¼šè£ç½®æœªå›å ±åº§æ¨™æˆ–æ²’æœ‰å¯ç”¨çš„å®šä½ä¾†æºã€‚',3:'é€¾æ™‚ï¼šå®šä½èŠ±å¤ªä¹…ï¼Œè«‹ç§»å‹•åˆ°è¼ƒé–‹é—Šè™•æˆ–ç¨å¾Œé‡è©¦ã€‚'};
      if (typeof err?.code==='number' && mapByCode[err.code]) return mapByCode[err.code];
      const msg=(err?.message||'').toLowerCase();
      if (msg.includes('only secure origins')||location.protocol!=='https:') return 'éœ€ä½¿ç”¨ HTTPS å®‰å…¨é€£ç·šæ‰å¯å®šä½ï¼Œè«‹æ”¹ç”¨ https:// ç¶²å€ã€‚';
      if (msg.includes('permission')&&msg.includes('denied')) return 'ä½ æ‹’çµ•äº†å®šä½æ¬Šé™ï¼Œè«‹åœ¨ç€è¦½å™¨ç¶²ç«™æ¬Šé™æŠŠã€Œä½ç½®ã€æ”¹ç‚ºå…è¨±ã€‚';
      if (msg.includes('timeout')) return 'å®šä½é€¾æ™‚ï¼Œè¨Šè™Ÿæˆ–ç’°å¢ƒå¯èƒ½ä¸ä½³ï¼Œè«‹ç§»å‹•åˆ°ç©ºæ› è™•å†è©¦ã€‚';
      if (msg.includes('unavailable')) return 'ç›®å‰ç„¡æ³•å–å¾—ä½ç½®ï¼Œå¯èƒ½æ˜¯è£ç½®æ²’æœ‰ GPS æˆ–å°šæœªå•Ÿç”¨ã€‚';
      return 'å®šä½å¤±æ•—ï¼š'+(err?.message||'ä¸æ˜éŒ¯èª¤');
    }
    function networkErrorToZh(err){
      const msg=(err?.message||'').toLowerCase();
      if (msg.includes('failed to fetch')) return 'ç¶²è·¯è«‹æ±‚å¤±æ•—ï¼šå¯èƒ½é›¢ç·šã€CORS æˆ–ä¼ºæœå™¨ç„¡å›æ‡‰ã€‚';
      if (msg.includes('cors')) return 'CORS é™åˆ¶ï¼šè«‹ç¢ºèªä¼ºæœå™¨å…è¨±æœ¬ç¶²åŸŸç™¼é€è«‹æ±‚ã€‚';
      return 'é€å‡ºå¤±æ•—ï¼š'+(err?.message||'ä¸æ˜éŒ¯èª¤');
    }
    function httpStatusToZh(status){
      const m={400:'éŒ¯èª¤çš„è«‹æ±‚ï¼ˆ400ï¼‰ï¼šè«‹æª¢æŸ¥é€å‡ºçš„è³‡æ–™æ ¼å¼ã€‚',401:'æœªæˆæ¬Šï¼ˆ401ï¼‰ï¼šè«‹ç¢ºèªä¼ºæœå™¨é‡‘é‘°æˆ–æˆæ¬Šè¨­å®šã€‚',403:'è¢«æ‹’çµ•ï¼ˆ403ï¼‰ï¼šä½ æ²’æœ‰æ¬Šé™å‘¼å«æ­¤ç«¯é»ã€‚',404:'æ‰¾ä¸åˆ°è³‡æºï¼ˆ404ï¼‰ï¼šè«‹ç¢ºèªç«¯é» URL æ˜¯å¦æ­£ç¢ºã€‚',413:'å…§å®¹å¤ªå¤§ï¼ˆ413ï¼‰ï¼šå‚³é€è³‡æ–™è¶…éä¼ºæœå™¨å…è¨±ä¸Šé™ã€‚',429:'è«‹æ±‚éå¤šï¼ˆ429ï¼‰ï¼šå‘¼å«å¤ªé »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚',500:'ä¼ºæœå™¨éŒ¯èª¤ï¼ˆ500ï¼‰ï¼šä¼ºæœå™¨ç™¼ç”Ÿå•é¡Œã€‚',502:'é–˜é“éŒ¯èª¤ï¼ˆ502ï¼‰ï¼šä¸Šæ¸¸æœå‹™ç•°å¸¸ã€‚',503:'æœå‹™ä¸å¯ç”¨ï¼ˆ503ï¼‰ï¼šä¼ºæœå™¨å¿™ç¢Œæˆ–ç¶­è­·ä¸­ã€‚',504:'é€¾æ™‚ï¼ˆ504ï¼‰ï¼šä¼ºæœå™¨å›æ‡‰é€¾æ™‚ã€‚'};
      return m[status]||`é€å‡ºå¤±æ•—ï¼ˆHTTP ${status}ï¼‰`;
    }

    async function postJSON(url,data){
      try{
        const res = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify(data)});
        if(!res.ok) throw new Error(httpStatusToZh(res.status));
        return true;
      }catch(err){ throw new Error(networkErrorToZh(err)); }
    }

    // ====== é›¢ç·šä½‡åˆ—ï¼ˆè‡ªå‹•è£œé€ï¼‰ ======
    const QUEUE_KEY='geo_queue_v1';
    function enqueue(record){
      const q = JSON.parse(localStorage.getItem(QUEUE_KEY)||'[]');
      q.push(record); localStorage.setItem(QUEUE_KEY, JSON.stringify(q));
    }
    async function flushQueue(){
      let q = JSON.parse(localStorage.getItem(QUEUE_KEY)||'[]');
      if(!q.length) return;
      statusEl.textContent = `åµæ¸¬åˆ° ${q.length} ç­†å¾…è£œé€è³‡æ–™ï¼Œå˜—è©¦ä¸Šå‚³ä¸­â€¦`; statusEl.className='status';
      const remain=[];
      for(const item of q){
        try{ await postJSON(FORMSPREE_ENDPOINT,item); }
        catch{ remain.push(item); }
        await sleep(200);
      }
      localStorage.setItem(QUEUE_KEY, JSON.stringify(remain));
      if(remain.length===0){ showToast('é›¢ç·šè³‡æ–™å·²å…¨éƒ¨è£œé€ âœ”'); }
    }
    window.addEventListener('online', flushQueue);

    // ====== ä¸»æµç¨‹ ======
    let lastClick=0;
    async function sendLocationFlow(){
      const now=Date.now(); if(now-lastClick < CLICK_COOLDOWN_MS) return; lastClick=now;
      if(!('geolocation' in navigator)){
        statusEl.textContent='æŠ±æ­‰ï¼Œç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½ã€‚å»ºè­°æ”¹ç”¨ Chrome / Safari / Edge ä¸¦ç¢ºä¿ HTTPSã€‚'; statusEl.className='status bad'; return;
      }
      const name=usernameInput.value.trim();
      if(!name){ statusEl.textContent='è«‹å…ˆè¼¸å…¥ä½¿ç”¨è€…åç¨±ï½'; statusEl.className='status bad'; return; }

      setLoading(true);
      const provider=mapProviderSel.value;
      const geoOpts={ enableHighAccuracy:true, timeout:15000, maximumAge:0 };

      navigator.geolocation.getCurrentPosition(async pos=>{
        const {latitude, longitude, accuracy}=pos.coords;
        const urls = buildMapUrls(latitude, longitude, provider);
        const payload={
          username:name,
          latitude, longitude, accuracy,
          maps_url_primary: urls.primary,
          maps_url_secondary: urls.secondary,
          maps_url_google: urls.google,
          maps_url_apple: urls.apple,
          maps_url_osm: urls.osm,
          latlng:`${latitude}, ${longitude}`,
          userAgent:navigator.userAgent,
          language:navigator.language,
          timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,
          online:navigator.onLine,
          timestamp:new Date().toISOString()
        };

        try{
          if(!navigator.onLine){ enqueue(payload); showToast('ç›®å‰é›¢ç·šï¼Œå·²åŠ å…¥ä½‡åˆ—'); }
          else{ await postJSON(FORMSPREE_ENDPOINT,payload); }

          revealResult(latitude, longitude, accuracy, provider);
          mapLink.href = urls.primary; altMapLink.href = urls.secondary;

          statusEl.textContent=`âœ“ å·²é€å‡ºï¼š${name}`; statusEl.className='status ok';
          localStorage.setItem('geo_name', name);
        }catch(err){
          revealResult(latitude, longitude, accuracy, provider);
          enqueue(payload); // å¤±æ•—ä¹Ÿå…ˆæ’éšŠï¼Œç­‰ç·šä¸Šå†è£œé€
          statusEl.textContent=String(err.message||err); statusEl.className='status bad';
        }finally{ setLoading(false); }
      }, err=>{
        statusEl.textContent=geoErrorToZh(err); statusEl.className='status bad'; setLoading(false);
      }, geoOpts);
    }

    // ====== åˆ†äº« ======
    async function shareCurrent(){
      const text=`${usernameInput.value.trim()} çš„ä½ç½®ï¼š
${coordsEl.textContent}
`;
      const url=mapLink.href;
      if(navigator.share){
        try{ await navigator.share({ title:'æˆ‘çš„ä½ç½®', text, url }); }catch{/* user canceled */}
      }else{
        try{ await navigator.clipboard.writeText(text+url); showToast('å·²è¤‡è£½åˆ†äº«æ–‡å­—èˆ‡é€£çµ'); }catch{ showToast('åˆ†äº«å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½'); }
      }
    }

    // ====== æ¬Šé™åµæ¸¬ ======
    async function initPermissionHints(){
      try{
        if(!('permissions' in navigator)) return;
        const q = await navigator.permissions.query({ name:'geolocation' });
        const set=(msg,cls='status')=>{ statusEl.textContent=msg; statusEl.className=cls; };
        if(q.state==='denied') set('å®šä½æ¬Šé™ç‚ºã€Œæ‹’çµ•ã€ã€‚è«‹åœ¨ç€è¦½å™¨ç¶²ç«™æ¬Šé™å°‡ã€Œä½ç½®ã€æ”¹ç‚ºå…è¨±å¾Œå†é‡è©¦ã€‚','status bad');
        else if(q.state==='prompt') set('é€å‡ºæ™‚æœƒè©¢å•å®šä½æ¬Šé™ï¼Œè«‹é»å…è¨±ä»¥å–å¾—åº§æ¨™ã€‚');
        else if(q.state==='granted') set('å®šä½æ¬Šé™å·²å…è¨±ï¼Œè¼¸å…¥åç¨±å¾Œå³å¯å‚³é€ã€‚','status ok');
        q.onchange=()=>initPermissionHints();
      }catch{}
    }

    // ====== äº‹ä»¶ç¶å®š ======
    usernameInput.addEventListener('input', ()=>{
      const hasName=usernameInput.value.trim()!==''; btnSend.disabled=!hasName; btnRetry.disabled=!hasName;
    });
    btnSend.addEventListener('click', sendLocationFlow);
    btnRetry.addEventListener('click', sendLocationFlow);
    btnShare.addEventListener('click', shareCurrent);

    async function copy(text,msg){ try{ await navigator.clipboard.writeText(text); showToast(msg); }catch{ showToast('è¤‡è£½å¤±æ•—'); } }
    copyLatBtn.addEventListener('click',()=>copy(latText.textContent,'å·²è¤‡è£½ç·¯åº¦'));
    copyLngBtn.addEventListener('click',()=>copy(lngText.textContent,'å·²è¤‡è£½ç¶“åº¦'));
    copyBothBtn.addEventListener('click',()=>copy(coordsEl.textContent,'å·²è¤‡è£½åº§æ¨™'));

    // ====== åˆå§‹åŒ– ======
    (function init(){
      if(location.protocol!=='https:' && location.hostname!=='localhost'){
        statusEl.textContent='âš  ç›®å‰ä¸æ˜¯ HTTPS é€£ç·šï¼Œç€è¦½å™¨å¯èƒ½æœƒæ“‹å®šä½ã€‚è«‹æ”¹ç”¨ https:// ç¶²å€ã€‚'; statusEl.className='status bad';
      }
      const saved=localStorage.getItem('geo_name'); if(saved){ usernameInput.value=saved; btnSend.disabled=false; btnRetry.disabled=false; }
      initPermissionHints();
      if(navigator.onLine) flushQueue();
    })();
  </script>
</body>
</html>
